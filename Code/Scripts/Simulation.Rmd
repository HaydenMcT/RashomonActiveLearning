---
title: "Simulation"
author: "Simon Dovan Nguyen"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    theme: lumen
    css: assets/styles.css
---

# Set Up

## Notes

SelectorPlotFunction is wrong - The non-identical errors at the end are most likely due to the breaking ties distance metric at the end. It's probably throwing away the remaining data that are less than SelectorN/not making the distance metric working \## Libr.

```{r message=FALSE, warning=FALSE}
library(MASS)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(class)
library(glmnet)
library(nnet)
library(RcppAlgos)  #TVA
library(data.table) #TVA
```

## Load Functions

```{r}
rm(list=ls())
directory = "/Users/simondn/Documents/RashomonActiveLearning/"

if(exists("directory")){
  source(paste0(directory,"Code/functions/Auxiliary/LoadFunctions.R"))
  }else if(!exists("directory")){source("Code/functions/Main/LoadFunctions.R")}

```

# Inputs

```{r}
### Input ###
# seed = 1234567890
seed = 123
N = 100
K = 4
NClass = 2
# ClassProportion = c(3/5, 2/5)
ClassProportion = rep(1/NClass, NClass)
MeanMatrix = rep(0,K)
CovCorrVal = -0.9
TestProportion = 0.2
SelectorN = 1
InitialN = 10
ModelType = "LASSO" #Supported Types: Logistic, LASSO, Multinomial, MultinomLASSO, RandomForest
NBins = 3
```

```{r}
### Seed ###
set.seed(seed)

### Data ###
DGPResults = GenerateDataFunc(N, K, NClass, ClassProportion, CovCorrVal, NBins = NBins)
dat = DGPResults$dat
TrueBetas = DGPResults$TrueBetas
# dat$Y = as.numeric(dat$Y)
```

```{r}
CovariateList = c("X1", "X2", "X3", "X4")
RashomonParameters = list(K = K, 
                          NBins = NBins,
                          H = Inf,                           # Maximum number of pools/splits
                          R = NBins+1,                       # Bins of each arm (assume 0 exists)
                          reg = 0.1,                         # Penalty on the splits
                          theta = 2,                         # Threshold; determine relative to best model
                          inactive = 0)
```

## Algorithm
```{r}
LabelName = "YStar"
SelectorN = 1
# ModelType = "Linear"
ModelType = "RashomonLinear"
```

```{r}
SelectorType = "BreakingTies"
iter=1
```

```{r}
SimulationFunc(dat = dat,
               LabelName,
               CovariateList,
               TestProportion = TestProportion,
               SelectorType = "Random",
               SelectorN = SelectorN,
               ModelType = ModelType,
               InitialN = InitialN,
               seed = seed) -> SimResultsRandom
```

```{r}
SimulationFunc(dat = dat,
               LabelName,
               CovariateList,
               TestProportion = TestProportion,
               SelectorType = "BreakingTies",
               SelectorN = SelectorN,
               ModelType = ModelType,
               InitialN = InitialN,
               seed = seed) -> SimResultsBreakingTies

```

## Visualize
```{r}
TestSetPredictionsRandom = SimResultsRandom$TestSetPrediction
TestSetPredictionsBreakingTies = SimResultsBreakingTies$TestSetPrediction

ModelListRandom = SimResultsRandom$ModelList
ModelListBreakingTies = SimResultsBreakingTies$ModelList
```

```{r}
### Stop Iter ###
TailN = 10
VarThreshold = 0.2
ErrorThreshold = 1.1
StopIterRandom = StoppingCriteriaFunc(SimResultsRandom, 
                                      ErrorThreshold = ErrorThreshold,
                                      VarThreshold = VarThreshold, 
                                      TailN = TailN)
StopIterBreakingTies = StoppingCriteriaFunc(SimResultsBreakingTies, 
                                            ErrorThreshold = ErrorThreshold,
                                            VarThreshold = VarThreshold, 
                                            TailN = TailN)

# StopIterRandom = StopIterRandom*SelectorN
# StopIterBreakingTies = StopIterBreakingTies*SelectorN

### Plots ###
xupper = NULL
ActiveLearningPlotFunc(Error = SimResultsRandom$Error,
                       StopIter = StopIterRandom,
                       SelectorType = SimResultsRandom$SelectorType,
                       SelectorN = SelectorN,
                       InitialTrainingSetN = SimResultsRandom$InitialTrainingSetN,
                       xupper = xupper) -> RandomPlot

ActiveLearningPlotFunc(Error = SimResultsBreakingTies$Error,
                       StopIter = StopIterBreakingTies,
                       SelectorType = SimResultsBreakingTies$SelectorType,
                       SelectorN = SelectorN,
                       InitialTrainingSetN = SimResultsBreakingTies$InitialTrainingSetN,
                       xupper = xupper) -> BreakingTiesPlot

SelectorTypeComparisonPlotFunc(SimulationType1 = SimResultsRandom,
                               SimulationType2 = SimResultsBreakingTies,
                               StopIter1 = StopIterRandom,
                               StopIter2 = StopIterBreakingTies,
                               SelectorN = SelectorN,
                               xupper = xupper) -> SelectorTypeComparisonPlot

ClassErrorPlotFunc(SimulationResults = SimResultsBreakingTies,
                   xupper = xupper) -> ClassErrorPlotBreakingTies
ClassErrorPlotFunc(SimulationResults = SimResultsRandom,
                   xupper = xupper) -> ClassErrorPlotRandom
```

```{r}
# ClassErrorPlotBreakingTies
# ClassErrorPlotRandom
# RandomPlot
# BreakingTiesPlot
SelectorTypeComparisonPlot
```





