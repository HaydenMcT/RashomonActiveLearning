---
title: "Scratch Work"
author: "Simon Dovan Nguyen"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    theme: lumen
    css: assets/styles.css
---

# Set Up

## Notes

## Libr.

```{r message=FALSE, warning=FALSE}
library(MASS)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(class)
library(glmnet)
library(nnet)
library(RcppAlgos)  #TVA
library(data.table) #TVA
```


## Load Functions


```{r}
rm(list=ls())
directory = "/Users/simondn/Documents/RashomonActiveLearning/"

if(exists("directory")){
  source(paste0(directory,"Code/functions/Main/LoadFunctions.R"))
  }else if(!exists("directory")){source("Code/functions/Main/LoadFunctions.R")}

```


# Inputs
```{r}
### Input ###
seed = 1234567890
N = 1000
K = 4
NClass = 2
# ClassProportion = c(3/5, 2/5)
ClassProportion = rep(1/NClass, NClass)
MeanMatrix = rep(0,K)
CovCorrVal = -0.9
TestProportion = 0.2
SelectorN = 1
InitialN = 10
ModelType = "LASSO" #Supported Types: Logistic, LASSO, Multinomial, MultinomLASSO, RandomForest
NBins = 3
```


```{r}
### Seed ###
set.seed(seed)

### Data ###
DGPResults = GenerateDataFunc(N, K, NClass, ClassProportion, CovCorrVal, NBins = NBins)
dat = DGPResults$dat
TrueBetas = DGPResults$TrueBetas
```

# Rashomon Test
```{r}
# Discretize Covariates
NBins = 3
dat = dat %>% mutate(across(starts_with("X"), ~ ntile(., NBins)))
dat$Y = as.numeric(dat$Y)

RashomonProfile = RashomonProfileFunc(dat, K, NBins)
RashomonSetNum = RashomonProfile$RashomonSetNum
RashomonLosses = RashomonProfile$RashomonLosses
PredictionObsModel = RashomonProfile$PredictionObsModel
PredictionObsModelRounded = RashomonProfile$PredictionObsModelRounded
RashomonSetTime = RashomonProfile$RashomonSetTime
WholeSetTime = RashomonProfile$WholeSetTime
dat = data.frame(dat)

for(col in 1:ncol(PredictionObsModel)){
   table(PredictionObsModel[,col]) %>% print()
   table(PredictionObsModelRounded[,col]) %>% print()
}
```


## Algorithm
```{r}
SimulationFunc(N = N,
               K = K,
               NClass = NClass,
               ClassProportion = ClassProportion,
               CovCorrVal = CovCorrVal,
               NBins = NBins,
               TestProportion = TestProportion,
               SelectorType = "Random",
               SelectorN = SelectorN,
               ModelType = ModelType,
               InitialN = InitialN,
               seed = seed) -> SimResultsRandom

SimulationFunc(N = N,
               K = K,
               NClass = NClass,
               ClassProportion = ClassProportion,
               CovCorrVal = CovCorrVal,
               NBins = NBins,
               TestProportion = TestProportion,
               SelectorType = "BreakingTies",
               SelectorN = SelectorN,
               ModelType = ModelType,
               InitialN = InitialN,
               seed = seed) -> SimResultsBreakingTies

dat = SimResultsBreakingTies$dat
TrueBetas = SimResultsBreakingTies$TrueBetas
```

## Visualize

```{r}
TestSetPredictionsRandom = SimResultsRandom$TestSetPrediction
TestSetPredictionsBreakingTies = SimResultsBreakingTies$TestSetPrediction

ModelListRandom = SimResultsRandom$ModelList
ModelListBreakingTies = SimResultsBreakingTies$ModelList
```


```{r}
### Stop Iter ###
TailN = 10
VarThreshold = 0.2
ErrorThreshold = 0.25
StopIterRandom = StoppingCriteriaFunc(SimResultsRandom, 
                                      ErrorThreshold = ErrorThreshold,
                                      VarThreshold = VarThreshold, 
                                      TailN = TailN)
StopIterBreakingTies = StoppingCriteriaFunc(SimResultsBreakingTies, 
                                            ErrorThreshold = ErrorThreshold,
                                            VarThreshold = VarThreshold, 
                                            TailN = TailN)

### Plots ###
xupper =NULL
ActiveLearningPlotFunc(Error = SimResultsRandom$Error,
                       StopIter = StopIterRandom,
                       SelectorType = SimResultsRandom$SelectorType,
                       InitialTrainingSetN = SimResultsRandom$InitialTrainingSetN,
                       xupper = xupper) -> RandomPlot

ActiveLearningPlotFunc(Error = SimResultsBreakingTies$Error,
                       StopIter = StopIterBreakingTies,
                       SelectorType = SimResultsBreakingTies$SelectorType,
                       InitialTrainingSetN = SimResultsBreakingTies$InitialTrainingSetN,
                       xupper = xupper) -> BreakingTiesPlot

SelectorTypeComparisonPlotFunc(SimulationType1 = SimResultsRandom,
                               SimulationType2 = SimResultsBreakingTies,
                               StopIter1 = StopIterRandom,
                               StopIter2 = StopIterBreakingTies,
                               xupper = xupper) -> SelectorTypeComparisonPlot

ClassErrorPlotFunc(SimulationResults = SimResultsBreakingTies,
                   xupper = xupper) -> ClassErrorPlotBreakingTies
ClassErrorPlotFunc(SimulationResults = SimResultsRandom,
                   xupper = xupper) -> ClassErrorPlotRandom
```


```{r}
# ClassErrorPlotBreakingTies
# ClassErrorPlotRandom
# RandomPlot
# BreakingTiesPlot
SelectorTypeComparisonPlot
```


# Beta Comparison
```{r}
CoefModelListRandom = numeric(length = length(ModelListRandom) * length(TrueBetas)) %>%
  matrix(nrow = length(ModelListRandom),
         ncol = length(TrueBetas))
CoefModelListBreakingTies = CoefModelListRandom
DifferenceModelListRandom = numeric(length = nrow(CoefModelListRandom))
DifferenceModelListBreakingTies = numeric(length = nrow(CoefModelListRandom))

for(i in 1:length(ModelListRandom)){
  CoefModelListRandom[i,] = as.numeric(coef(ModelListRandom[[i]])[-1])
  CoefModelListBreakingTies[i,] = as.numeric(coef(ModelListBreakingTies[[i]])[-1])
  # CoefModelListRandom[i,] = as.numeric(coef(ModelListRandom[[i]]))
  # CoefModelListBreakingTies[i,] = as.numeric(coef(ModelListBreakingTies[[i]]))
}
```

```{r}
CovariateLook = 2
for(j in 1:length(ModelListRandom)){
  DifferenceModelListRandom[j] = abs(CoefModelListRandom[j,CovariateLook] - TrueBetas[CovariateLook])
  DifferenceModelListBreakingTies[j] = abs(CoefModelListBreakingTies[j,CovariateLook] - TrueBetas[CovariateLook])
}
```


```{r}
CovariateDiffError = data.frame(cbind(DifferenceModelListRandom,DifferenceModelListBreakingTies)) %>%
    mutate(iter = 1:length(DifferenceModelListRandom)) %>%
    pivot_longer(-iter)
colnames(CovariateDiffError) = c("iter", "SelectorType", "error")

  ### Plot ###
CovariateDiffPlot = ggplot() +
    geom_line(data = CovariateDiffError,
              mapping = aes(x = iter, y = error, color = SelectorType)) +
  ylab(paste0("X",CovariateLook, " LASSO Bias")) +
  ylim(0,1)
CovariateDiffPlot
```
```{r}
rbind(TrueBetas,
      CoefModelListRandom[nrow(CoefModelListRandom),],
      CoefModelListBreakingTies[nrow(CoefModelListBreakingTies),]) -> CoefficientResults
rownames(CoefficientResults) = c("True", "Random", "BreakingTies")
colnames(CoefficientResults) = paste0("X", 1:K)
CoefficientResults %>% round(5)
```

# Standard Error of Betas
```{r}
# ModelEndBT = ModelListBreakingTies[771][[1]]
```

```{r}
# SEList = numeric(4*length(ModelListBreakingTies)) %>% 
#   matrix(ncol = 4)
# 
# for(i in 1:length(ModelListBreakingTies)){
#   SEList[i,] = summary(ModelListBreakingTies[[i]])$coefficients[,2]
# }
```

```{r}
# CovariateSE = SEList %>% 
#   data.frame %>%
#   mutate(iter = SimResultsBreakingTies$InitialTrainingSetN:(nrow(SEList)+SimResultsBreakingTies$InitialTrainingSetN-1)) %>%
#     pivot_longer(-iter)
# colnames(CovariateSE) = c("iter", "Covariate", "SE")
# 
#   ### Plot ###
# CovariateDiffPlot = ggplot() + 
#     geom_line(data = CovariateSE,
#               mapping = aes(x = iter, y = SE, color = Covariate)) + 
#   ylab("Number of annotated observations")
#   # xlim(700,800) +
#   # ylim(0, 0.2)
# CovariateDiffPlot
```




